<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProfileBasedGunFitter</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #2e4a3d;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            color: #e5e7d5;
            overflow-x: hidden;
        }
        .loader {
            border: 4px solid #4a7043;
            border-top: 4px solid #8b8d42;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .image-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        #confettiOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1000;
            pointer-events: none;
            display: none;
        }
        #confettiOverlay.show {
            display: block;
        }
        #adPopup {
            position: fixed;
            width: 300px;
            height: 300px;
            background-color: #3e5c4e;
            border: 2px solid #8b8d42;
            border-radius: 8px;
            z-index: 1001;
            display: none;
            cursor: pointer;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        #adPopup.show {
            display: block;
        }
        #adPopup img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }
        #adPopup div {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #e5e7d5;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            white-space: pre-line;
        }
    </style>
</head>
<body class="bg-[#2e4a3d] flex items-center justify-center min-h-screen p-4">
    <!-- Confetti Overlay -->
    <img id="confettiOverlay" src="https://raw.githubusercontent.com/llcaptainmorgan/ProfileBasedGunFitter/main/confetti.gif" alt="Confetti">

    <!-- Ad Popup -->
    <div id="adPopup">
        <img src="https://raw.githubusercontent.com/llcaptainmorgan/ProfileBasedGunFitter/main/i_like_guns.gif" alt="I Like Guns">
        <div>DO YOU\nLIKE GUNS?</div>
    </div>

    <div class="bg-[#3e5c4e] rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-4xl flex flex-col md:flex-row gap-6">
        <!-- Controls Section -->
        <div class="md:w-1/3 flex flex-col items-center justify-start py-4 space-y-4">
            <h1 class="text-3xl font-bold text-[#e5e7d5] mb-6 text-center">ProfileBasedGunFitter</h1>
            <div class="w-full">
                <label for="profileUpload" class="block text-sm font-medium text-[#e5e7d5] mb-2">Upload Profile Picture</label>
                <input type="file" id="profileUpload" accept="image/*" class="block w-full text-sm text-[#e5e7d5] border border-[#4a7043] rounded-lg cursor-pointer bg-[#2e4a3d] focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-[#8b8d42] file:text-[#e5e7d5] hover:file:bg-[#6b6d32]">
                <p id="fileName" class="mt-2 text-sm text-[#a3a68b] text-center"></p>
            </div>
            <button id="generateBtn" class="w-full bg-gradient-to-r from-[#8b8d42] to-[#4a7043] text-[#e5e7d5] font-semibold py-3 px-6 rounded-full shadow-lg hover:from-[#6b6d32] hover:to-[#3a5633] transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-[#8b8d42] disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center" disabled>
                <span id="generateBtnText">Generate Gun Pic</span>
                <div id="loadingSpinner" class="loader hidden"></div>
            </button>
            <button id="saveBtn" class="w-full bg-gradient-to-r from-[#4a7043] to-[#8b8d42] text-[#e5e7d5] font-semibold py-3 px-6 rounded-full shadow-lg hover:from-[#3a5633] hover:to-[#6b6d32] transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-[#4a7043] disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Save Meme
            </button>
            <p id="statusMessage" class="mt-4 text-sm text-[#a3a68b] text-center"></p>
        </div>
        <!-- Image Display Section -->
        <div class="md:w-2/3 flex flex-col items-center justify-center space-y-6">
            <div class="w-full bg-[#3e5c4e] border border-[#4a7043] rounded-lg overflow-hidden shadow-inner flex items-center justify-center min-h-[200px] md:min-h-[250px] aspect-video image-container">
                <img id="uploadedImage" src="https://placehold.co/600x400/3e5c4e/e5e7d5?text=Your+Profile+Pic" alt="Uploaded Profile Picture" class="w-full h-auto object-contain rounded-lg">
            </div>
            <div class="w-full bg-[#3e5c4e] border border-[#4a7043] rounded-lg overflow-hidden shadow-inner flex items-center justify-center min-h-[200px] md:min-h-[250px] aspect-video image-container">
                <img id="generatedGunImage" src="https://placehold.co/600x400/3e5c4e/e5e7d5?text=Generated+Gun+Pic" alt="Generated Gun Picture" class="w-full h-auto object-contain rounded-lg">
            </div>
        </div>
    </div>

    <script>
        // Get references to DOM elements
        const profileUpload = document.getElementById('profileUpload');
        const fileNameLabel = document.getElementById('fileName');
        const generateBtn = document.getElementById('generateBtn');
        const saveBtn = document.getElementById('saveBtn');
        const uploadedImage = document.getElementById('uploadedImage');
        const generatedGunImage = document.getElementById('generatedGunImage');
        const statusMessage = document.getElementById('statusMessage');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const generateBtnText = document.getElementById('generateBtnText');
        const confettiOverlay = document.getElementById('confettiOverlay');
        const adPopup = document.getElementById('adPopup');
        const adAudio = new Audio('https://raw.githubusercontent.com/llcaptainmorgan/ProfileBasedGunFitter/main/I%20Like%20Guns.mp3');

        // List of random prompts for gun image generation
        const basePrompts = [
            "Bolt-Action Rifle, like Remington 700, manually operated, used for hunting and precision shooting",
            "Semi-Automatic Pistol, like Glock 17, one round per trigger pull, for self-defense and law enforcement",
            "Revolver, like Smith & Wesson Model 29, rotating cylinder, reliable for sport shooting",
            "Pump-Action Shotgun, like Mossberg 500, manually cycled, versatile for hunting and home defense",
            "Fully Automatic Machine Gun, like M249 SAW, continuous fire, used for military suppressive fire",
            "Lever-Action Rifle, like Winchester Model 1894, lever mechanism, iconic for hunting",
            "Submachine Gun, like MP5, compact pistol-caliber, for close-quarters combat",
            "Designated Marksman Rifle, like M14 DMR, semi-automatic, for long-range military precision",
            "Flintlock Musket, like Brown Bess, muzzle-loading, used in historical reenactments",
            "Anti-Materiel Rifle, like Barrett M82, large-caliber, for destroying equipment or extreme ranges",
            "water gun, colorful plastic, used for playful water fights",
            "toy gun, plastic with sound effects, for kids' play",
            "lego brick gun, built from colorful lego pieces, for imaginative play",
            "finger guns, hand gesture mimicking a pistol, for playful expression",
            "video game controller gun, plastic peripheral for shooting games",
            "arcade gun, mounted light gun for arcade shooting games",
            "bazooka, large rocket launcher, for military anti-tank use",
            "flamethrower, projecting ignited fuel, for military or controlled burns",
            "biceps flexed as guns, muscular arms, slang for strength"
        ];

        const styles = [
            "standard gun", "cinematic gun", "military gun", "toy gun", 
            "water gun", "arcade", "lego brick"
        ];

        // Event listener for profile picture upload
        profileUpload.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                fileNameLabel.textContent = `Selected: ${file.name}`;
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedImage.src = e.target.result;
                    generateBtn.disabled = false;
                    statusMessage.textContent = 'Ready to generate gun pic!';
                };
                reader.readAsDataURL(file);
            } else {
                fileNameLabel.textContent = 'No image selected';
                uploadedImage.src = "https://placehold.co/600x400/3e5c4e/e5e7d5?text=Your+Profile+Pic";
                generateBtn.disabled = true;
                saveBtn.disabled = true;
                statusMessage.textContent = 'Please select a profile picture.';
            }
        });

        // Function to resize and crop an image to fit a target size
        function resizeAndCrop(img, targetWidth, targetHeight) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = targetWidth;
            canvas.height = targetHeight;

            const imgAspectRatio = img.width / img.height;
            const targetAspectRatio = targetWidth / targetHeight;

            let sx, sy, sWidth, sHeight;
            let dx = 0, dy = 0, dWidth = targetWidth, dHeight = targetHeight;

            if (imgAspectRatio > targetAspectRatio) {
                sHeight = img.height;
                sWidth = sHeight * targetAspectRatio;
                sx = (img.width - sWidth) / 2;
                sy = 0;
            } else {
                sWidth = img.width;
                sHeight = sWidth / targetAspectRatio;
                sy = (img.height - sHeight) / 2;
                sx = 0;
            }

            ctx.drawImage(img, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight);
            return canvas.toDataURL('image/png');
        }

        // Popup ad functionality
        function showAdPopup() {
            const maxX = window.innerWidth - 300; // Popup width
            const maxY = window.innerHeight - 300; // Popup height
            const randomX = Math.floor(Math.random() * maxX);
            const randomY = Math.floor(Math.random() * maxY);
            
            adPopup.style.left = `${randomX}px`;
            adPopup.style.top = `${randomY}px`;
            adPopup.classList.add('show');
            adAudio.play().catch(error => console.error('Audio play failed:', error));
        }

        function hideAdPopup() {
            adPopup.classList.remove('show');
            adAudio.pause();
            adAudio.currentTime = 0;
        }

        adPopup.addEventListener('click', hideAdPopup);

        // Start popup interval
        setInterval(showAdPopup, 20000);
        // Show first popup after 20 seconds
        setTimeout(showAdPopup, 20000);

        // Event listener for generate button
        generateBtn.addEventListener('click', async () => {
            if (!profileUpload.files[0]) {
                statusMessage.textContent = 'Please upload a profile picture first.';
                return;
            }

            generateBtn.disabled = true;
            saveBtn.disabled = true;
            generateBtnText.textContent = 'Generating...';
            loadingSpinner.classList.remove('hidden');
            statusMessage.textContent = 'Generating your unique gun pic, please wait...';
            generatedGunImage.src = "https://placehold.co/600x400/3e5c4e/e5e7d5?text=Generating...";

            let selectedPromptParts = [];
            selectedPromptParts.push(basePrompts[Math.floor(Math.random() * basePrompts.length)]);
            selectedPromptParts.push(styles[Math.floor(Math.random() * styles.length)]);

            const finalPrompt = selectedPromptParts.join(", ");
            console.log("Generated Prompt:", finalPrompt);

            try {
                const payload = {
                    instances: { prompt: finalPrompt },
                    parameters: { "sampleCount": 1 }
                };
                const apiKey = "AIzaSyBBdSL8uesGqhgu6F2wS7nzkY8x2GMUVq8";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} - ${errorData.error.message || 'Unknown error'}`);
                }

                const result = await response.json();
                let gunImageUrl;

                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    gunImageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                } else {
                    throw new Error('No image data received from API.');
                }

                const profileImg = new Image();
                const gunImg = new Image();

                const loadProfilePromise = new Promise((resolve, reject) => {
                    profileImg.onload = () => resolve();
                    profileImg.onerror = reject;
                    profileImg.src = uploadedImage.src;
                });

                const loadGunPromise = new Promise((resolve, reject) => {
                    gunImg.onload = () => resolve();
                    gunImg.onerror = reject;
                    gunImg.src = gunImageUrl;
                });

                await Promise.all([loadProfilePromise, loadGunPromise]);

                statusMessage.textContent = 'Combining images and adding caption...';

                const memeCanvas = document.createElement('canvas');
                const memeCtx = memeCanvas.getContext('2d');
                const imageSectionHeight = 960;
                const imageSectionWidth = 1080;
                const captionHeight = 100;
                memeCanvas.width = imageSectionWidth;
                memeCanvas.height = (imageSectionHeight * 2) + captionHeight;

                const resizedProfileDataUrl = resizeAndCrop(profileImg, imageSectionWidth, imageSectionHeight);
                const tempProfileImg = new Image();
                await new Promise(resolve => { tempProfileImg.onload = resolve; tempProfileImg.src = resizedProfileDataUrl; });
                memeCtx.drawImage(tempProfileImg, 0, 0, imageSectionWidth, imageSectionHeight);

                const resizedGunDataUrl = resizeAndCrop(gunImg, imageSectionWidth, imageSectionHeight);
                const tempGunImg = new Image();
                await new Promise(resolve => { tempGunImg.onload = resolve; tempGunImg.src = resizedGunDataUrl; });
                memeCtx.drawImage(tempGunImg, 0, imageSectionHeight, imageSectionWidth, imageSectionHeight);

                const memeText = "This is the gun that fits you best based on your profile picture";
                memeCtx.font = 'bold 40px Impact, sans-serif';
                memeCtx.textAlign = 'center';
                memeCtx.fillStyle = '#e5e7d5';
                memeCtx.strokeStyle = '#2e4a3d';
                memeCtx.lineWidth = 6;

                const textX = memeCanvas.width / 2;
                const textY = (imageSectionHeight * 2) + (captionHeight / 2) + 10;
                memeCtx.strokeText(memeText, textX, textY);
                memeCtx.fillText(memeText, textX, textY);

                generatedGunImage.src = memeCanvas.toDataURL('image/png');
                saveBtn.disabled = false;
                statusMessage.textContent = 'Meme generated successfully! Click "Save Meme" to download.';

                // Show confetti for 5 seconds
                confettiOverlay.classList.add('show');
                setTimeout(() => {
                    confettiOverlay.classList.remove('show');
                }, 5000);

            } catch (error) {
                console.error('Error generating meme:', error);
                statusMessage.textContent = `Error generating meme: ${error.message}. Please try again.`;
                generatedGunImage.src = "https://placehold.co/600x400/3e5c4e/e5e7d5?text=Error";
            } finally {
                generateBtn.disabled = false;
                generateBtnText.textContent = 'Generate Gun Pic';
                loadingSpinner.classList.add('hidden');
            }
        });

        // Event listener for save button
        saveBtn.addEventListener('Click', () => {
            const imageUrl = generatedGunImage.src;
            if (imageUrl && imageUrl.startsWith('data:image/png;base64,')) {
                const link = document.createElement('a');
                link.href = imageUrl;
                link.download = `gun_meme_${Date.now()}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                statusMessage.textContent = 'Picture downloaded!';
            } else {
                statusMessage.textContent = 'No Picture to save yet!';
            }
        });

        // Initial state setup
        fileNameLabel.textContent = 'No image selected';
        statusMessage.textContent = 'Upload a profile picture to get started!';
    </script>
</body>
</html>
